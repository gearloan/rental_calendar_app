#!/bin/bash
set -euo pipefail

echo "ğŸš€ Starting deploy..."
echo

echo "ğŸ”§ Building Tailwind CSS"
npx tailwindcss -i ./app/assets/tailwind/application.css -o ./app/assets/builds/application.css --minify

echo "ğŸ“¦ Building JavaScript (esbuild)"
yarn build

echo "ğŸ¯ Precompiling Rails assets"
RAILS_ENV=production bin/rails assets:clobber
RAILS_ENV=production bin/rails assets:precompile

echo
echo "ğŸ” Deployed asset fingerprints:"
find public/assets -name "application-*.css" -o -name "application-*.js" | sort

echo
echo "ğŸ›« Deploying to Fly.io..."
if fly deploy; then
  echo "âœ… Deploy succeeded!"
else
  echo "âŒ Deploy failed. You can rollback with:"
  echo "   fly deploy --image $(fly status -j | jq -r '.Deployment.ImageRef')"
  exit 1
fi
