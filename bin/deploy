#!/bin/bash
set -euo pipefail

# === Verify flyctl is available ===
if ! command -v flyctl &> /dev/null; then
  echo "âŒ Error: 'flyctl' not found in PATH."
  echo "ğŸ‘‰ Install it via: curl -L https://fly.io/install.sh | sh"
  echo "ğŸ‘‰ And add this to your shell config: export PATH=\"\$HOME/.fly/bin:\$PATH\""
  exit 1
fi

echo "ğŸ”§ Building Tailwind CSS"
npx tailwindcss -i ./app/assets/tailwind/application.css -o ./app/assets/builds/application.css --minify

echo "ğŸ“¦ Building JavaScript (esbuild)"
yarn build

echo "ğŸ¯ Precompiling Rails assets"
RAILS_ENV=production bin/rails assets:clobber
RAILS_ENV=production bin/rails assets:precompile

echo
echo "ğŸ” Deployed asset fingerprints:"
find public/assets -name "application-*.css" -o -name "application-*.js" | sort

echo
echo "ğŸ›« Deploying to Fly.io..."
flyctl deploy
